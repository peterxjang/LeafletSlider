<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Time Slider Example</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" /><![endif]-->
    <link rel="stylesheet" href="styles.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="dist/css/bootstrap-multiselect.css" type="text/css"/>
 
</head>

<body>

    <div id="map" style="width: 75%; height: 525px"></div>

    <!-- <div class="inputs" id="event-types">
      <input type="checkbox" class="event-type" name="plastics-and-rubber" value="Plastics and Rubber" checked="true">
      <label for="plastics-and-rubber">Plastics and Rubber</label>
      <input type="checkbox" class="event-type" name="furniture" value="Furniture" checked="true">
      <label for="furniture">Furniture</label>
      <input type="checkbox" class="event-type" name="fabricated-metals" value="Fabricated Metals" checked="true">
      <label for="fabricated-metals">Fabricated Metals</label>
      <input type="checkbox" class="event-type" name="electric-utilities" value="Electric Utilities" checked="true">
      <label for="electric-utilities">Electric Utilities</label>
      <input type="checkbox" class="event-type" name="nonmetallic-mineral-product" value="Nonmetallic Mineral Product" checked="true">
      <label for="nonmetallic-mineral-product">Nonmetallic Mineral Product</label>
      <input type="checkbox" class="event-type" name="textiles" value="Textiles" checked="true">
      <label for="textiles">Textiles</label>
    </div> -->
  <div style="background-color: burlywood; border-radius: 5px;">
    <select class="inputs" id="event-types" multiple="multiple">
      <optgroup label="Industry">
      <option type="checkbox" class="event-type" name="plastics-and-rubber" value="Plastics and Rubber" selected="selected">Plastics and Rubber</option>
      <option type="checkbox" class="event-type" name="furniture" value="Furniture" selected="selected">Furniture</option>
      <option type="checkbox" class="event-type" name="fabricated-metals" value="Fabricated Metals" selected="selected">Fabricated Metals</option>
      <option type="checkbox" class="event-type" name="electric-utilities" value="Electric Utilities" selected="selected">Electric Utilities</option>
      <option type="checkbox" class="event-type" name="nonmetallic-mineral-product" value="Nonmetallic Mineral Product" selected="selected">Nonmetallic Mineral Product</option>
      <option type="checkbox" class="event-type" name="textiles" value="Textiles" selected="selected">Textiles</option>
      <option type="checkbox" class="event-type" name="metal-mining" value="Metal Mining" selected="selected">Metal Mining</option>
      <option type="checkbox" class="event-type" name="tobacco" value="Tobacco" selected="selected">Tobacco</option>
      <option type="checkbox" class="event-type" name="machinery" value="Machinery" selected="selected">Machinery</option>
      <option type="checkbox" class="event-type" name="leather" value="Leather" selected="selected">Leather</option>
      <option type="checkbox" class="event-type" name="paper" value="Paper" selected="selected">Paper</option>
      <option type="checkbox" class="event-type" name="publishing" value="Publishing" selected="selected">Publishing</option>
      <option type="checkbox" class="event-type" name="printing" value="Printing" selected="selected">Printing</option>
      <option type="checkbox" class="event-type" name="electrical-equipment" value="Electrical Equipment" selected="selected">Electrical Equipment</option>
      <option type="checkbox" class="event-type" name="chemicals" value="Chemicals" selected="selected">Chemicals</option>
      <option type="checkbox" class="event-type" name="petroleum-bulk-terminals" value="Petroleum Bulk Terminals" selected="selected">Petroleum Bulk Terminals</option>
      <option type="checkbox" class="event-type" name="beverages" value="Beverages" selected="selected">Beverages</option>
      <option type="checkbox" class="event-type" name="hazardous-waste" value="Hazardous Waste" selected="selected">Hazardous Waste</option>
      <option type="checkbox" class="event-type" name="wood-products" value="Wood Products" selected="selected">Wood Products</option>
      <option type="checkbox" class="event-type" name="textile-product" value="Textile Product" selected="selected">Textile Product</option>
      <option type="checkbox" class="event-type" name="petroleum" value="Petroleum" selected="selected">Petroluem</option>
      <option type="checkbox" class="event-type" name="computers-and-electronic-products" value="Computers and Electronic Products" selected="selected">Computers and Electronic Products</option>
      <option type="checkbox" class="event-type" name="apparel" value="Apparel" selected="selected">Apparel</option>
      <option type="checkbox" class="event-type" name="food" value="Food" selected="selected">Food</option>
      <option type="checkbox" class="event-type" name="chemical-wholesalers" value="Chemical Wholesalers" selected="selected">Chemical Wholesalers</option>
      <option type="checkbox" class="event-type" name="transportation-equipment" value="Transportation Equipment" selected="selected">Transportation Equipment</option>
      <option type="checkbox" class="event-type" name="primary-metals" value="Primary Metals" selected="selected">Primary Metals</option>
      <option type="checkbox" class="event-type" name="miscellaneous-manufacturing" value="Miscellaneous Manufacturing" selected="selected">Miscellaneous Manufacturing</option>
      <option type="checkbox" class="event-type" name="other" value="Other" selected="selected">Other</option>
    </optgroup>
    </select>
  </div>
    <!-- Initialize the plugin: -->
    <script type="text/javascript">
      $(document).ready(function() {
          $('#event-types').multiselect({
            enableFiltering: true,
            includeSelectAllOption: true,
            buttonWidth: "300px",
            maxHeight: "100px",
            enableCollapsibleOptGroups: true,
            enableClickableOptGroups: true
          });
     });
    </script>

    <div class="main" class="inputs" id="years">
      <input type="range" class="year" min="1987" max="2020" value=1987 id="slider">
      <div id="selector">
        <div class="SelectBtn"></div>
        <div id="SelectValue"></div>
      </div>
    </div>

    <script>
      var slider = document.getElementById("slider");
      var selector = document.getElementById("selector");
      
      SelectValue.innerHTML = slider.value;

      slider.oninput = function() {
        SelectValue.innerHTML = this.value;
        selector.style.left = this.value;
      }
    </script>

    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>


    <script>
      // Setup map
      var terrain = L.tileLayer('http://tile.stamen.com/terrain/{z}/{x}/{y}.jpg'),
          streets =  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          });
        
      var baseMaps = {
          "Terrain": terrain,
          "Streets": streets
        };

      var myMap = L.map('map', {
        center: [37.41907305286242, -117.61962890625001],
        zoom: 4,
        minZoom: 6,
        maxZoom: 12,
        layers: [terrain, streets]
        });

      L.control.layers(baseMaps).addTo(myMap);

      // Get initial checkbox states from HTML
      var checkboxStates;
      function updateCheckboxStates() {
        checkboxStates = {
          years: [],
          eventTypes: []
        }
        for (let input of document.querySelectorAll('.event-type')) {
          if(input.selected) {
            switch (input.className) {
              case 'event-type': checkboxStates.eventTypes.push(input.value); break
            }
          }
        }
        for (let input of document.querySelectorAll('input')) {
          if (input.className === "year") {
            checkboxStates.years.push(input.value);
          }
        }
      }
      updateCheckboxStates();



      // Define geojson layer (without any data yet)
      var geojsonLayer = L.geoJson(null, {
        filter: function(feature) {
          var isYearChecked = checkboxStates.years.includes(feature.properties.year.substr(0,4));
          var isEventTypeChecked = checkboxStates.eventTypes.includes(feature.properties.industry);
          return isYearChecked && isEventTypeChecked;  
        },
        onEachFeature: function(feature, layer) {
          if (feature.properties) {
            var year = feature.properties.year.substr(0, 4);
                    var pollutant = feature.properties.pollutant;
                    var release = feature.properties.release;
                    var unit = feature.properties.unit;
                    var facility = feature.properties.f;
                    var facility_id = feature.properties.frs_id;
                    var industry = feature.properties.industry;
                    layer.bindPopup("<strong>YEAR: </strong>" + year + "<br /><strong> POLLUTANT: </strong>" + pollutant + "<br /><strong> RELEASE: </strong>" + release + " " + unit + "<br /><strong> FACILITY: </strong>" + facility + "<br /><strong> FACILITY ID: </strong>" + facility_id + "<br /><strong> INDUSTRY: </strong>" + industry, { maxWidth: 300, maxHeight: 200, autoPan: true, closeButton: true });
          }
        },
        pointToLayer: function (feature, latlng) {
          if (feature.properties.industry === "Plastics and Rubber") {
          var geojsonMarkerOptions = {
          radius: 3,
          fillColor: "#ff7800",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
          };
        } else if (feature.properties.industry === "Furniture") {
          var geojsonMarkerOptions = {
          radius: 3,
          fillColor: "#e1118e",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
          };
        } else {
          var geojsonMarkerOptions = {
          radius: 3,
          fillColor: "#000000",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
          };
        };
          return L.circleMarker(latlng, geojsonMarkerOptions);
        }
      }).addTo(myMap);

      // Get JSON from web request
      $.getJSON('http://localhost:8000/ca_pollution/api/tri_releases/', function(json) {
        // Update geojson layer with data
        console.log(json);
        geojsonLayer.addData(json); 
        console.log(geojsonLayer);

        // Listen to 'change' event of all inputs
        for (let input of document.querySelectorAll('input')) {
          input.onchange = (e) => {
            geojsonLayer.clearLayers()
            updateCheckboxStates();
            geojsonLayer.addData(json);   
          }
        }
      });
    </script>


<script type="text/javascript" src="dist/js/bootstrap-multiselect.js"></script>

</body>

</html>
